/*
select * from Appeal_themes;
select * from Channels;
select * from Rate_Plans;
select * from Appeals;
select * from Actions;

drop table Appeals;
drop table Actions;
drop table Appeal_themes;
drop table Channels;
drop table Rate_Plans;
*/

-- =========================APPEAL THEMES=========================================
create table Appeal_themes(
	theme_id INT 		  not null,
	def      VARCHAR(127) not null,
	constraint pk_appeal_themes primary key (theme_id)
);

insert into Appeal_themes(theme_id,def) 
       values(1,'Узнать о тарифах'),
       		 (2,'Смена тарифа'),
       		 (3,'Смена сим-карты с сохраниением нормера'),
       		 (4,'Переоформление номера на другое лицо'),
       		 (5,'Красивый номер'),
       		 (6,'Подключенные услуги'),
       		 (7,'Причина списание средств'),
       		 (8,'Остаток интернет трафика'),
       		 (9,'Проблема со связью'),
       		 (10,'Сменить пароль ЛК'),
       		 (11,'Детализация счета'),
       		 (12,'Узнать баланс'),
       		 (13,'Средства не поступили на счет'),
       		 (14,'Подключение/отключение услуги');

/*
select * from Appeal_themes;
drop table Appeal_themes;
*/

       		
       		
       		

-- =========================CHANNELS=========================================
create table Channels(
	channel_id INT 		    not null,
	def        VARCHAR(127) not null,
	constraint pk_channels primary key (channel_id)
);


insert into Channels(channel_id,def) 
       values (1,'Личный кабинет'),
		      (2,'Контакт центр'),
		      (3,'Мегафон-ритейл');

/*
select * from Channels;
drop table Channels;
*/

		     
		     
		     
       		 
-- =========================RATE PLANS=========================================
create table Rate_Plans(
	rate_plan_id INT          not null,
	def          VARCHAR(127) not null,
	constraint pk_rate_plans primary key (rate_plan_id)
);


insert into Rate_Plans(rate_plan_id,def) 
       values (1,'Включайся Общайся!'),
		      (2,'Включайся Говори!'),
		      (3,'Включайся Пиши!'),
		      (4,'Включайся Смотри!'),
		      (5,'Включайся Слушай'),
		      (6,'Включайся Премиум'),
		      (7,'Переходи на Ноль'),
		      (8,'Тёплый прием S'),
		      (9,'Тёплый прием M');

/*
select * from Rate_Plans;
drop table Rate_Plans;
*/


		     
-- =========================LK_ACTIONS=========================================	     
create table lk_actions (
	lk_actions_id  int not null,
	name_actions varchar (20),
	constraint pk_lk_actions_id primary key (lk_actions_id)
);


insert into lk_actions (lk_actions_id,name_actions)
	values (0,'Вход'),
		   (1,'Смена ТП'),
		   (2,'Подключение услуги'),
		   (3,'Отключение услуги'),
		   (4,'Запрос детализации'),
		   (5,'Смена пароля');

/*
select * from lk_actions;
drop table lk_actions;
*/


	
-- =========================APPEALS=========================================
create table Appeals
(
	appeal_id INT not null generated by default as identity,
	theme_id INT not null,
	subs_id INT not null,
	rate_plan_id INT not null,
	reg_date TIMESTAMP not null,
	channel_id INT not null,
	balance INT not null,
	constraint pk_appeals primary key(appeal_id),
	constraint fk_appeals_appealtheme foreign key(theme_id)
		references Appeal_themes(theme_id),
	constraint fk_appeals_rate_plans foreign key(rate_plan_id)
		references Rate_Plans(rate_plan_id),
	constraint fk_appeals_channels foreign key(channel_id)
		references Channels(channel_id)
);

insert into Appeals (appeal_id,theme_id,subs_id,rate_plan_id,reg_date,channel_id,balance)
	   values  (1,4,01,2,'2018-05-05 10:20:00',2,100),   --Бабка
			(2,4,01,2,'2018-05-05 11:15:00',3,100),   --Бабка в ретейле
			
			(3,2,01,2,'2018-06-15 14:30:00',2,100),   --Бабка позвонила
			(4,2,01,3,'2018-06-15 15:05:00',2,100),	 --Бабка позвонила опять(поменяла ТП с 2 на 3

			(5,2,02,5,'2018-05-18 12:25:00',2,150),  -- Маша позвонила и ей поменяли ТП

			(6,5,03,6,'2018-05-20 17:45:00',2,500),  -- Саша позвонил за красивым номером
			(7,5,03,6,'2018-05-20 18:15:00',3,500),  -- Саша поехал в ретайл

			(8,14,03,6,'2018-05-25 10:20:00',2,550), -- Саша не то отклчил, просит переподключить

			(9,4,03,6,'2018-05-28 15:00:00',2,550),  -- Саша пришел в ретейл переоформить симку и всё

			(10,10,04,1,'2018-05-20 18:00:00',2,120),  -- Лёша хочет сменить пароль в ЛК

			(11,2,05,7,'2018-05-25 14:05:00',2,350), -- Аркаша позвонил по теме смена ТП
			(12,2,05,2,'2018-05-25 15:35:00',3,100), -- Аркаша сменил ТП в ретайле

			(13,7,06,1,'2018-05-16 17:15:00',2,20),  -- Ангелина позвонила по причине списания средств
			(14,14,06,1,'2018-05-16 18:05:00',2,20), -- Ангелина позвонила что бы ей отключили услугу

			(15,13,07,6,'2018-05-17 13:20:00',2,100), --Коля позвонил узнать, почему не пришли деньги
			(16,13,07,6,'2018-05-17 13:50:00',2,1100),--Коля опять звонит по деньгам, но они уже есть

			(17,3,08,2,'2018-05-10 11:33:00',2,400), -- Аня позвонила по смене симки
			(18,3,08,2,'2018-05-10 12:10:00',2,300); -- Аня пошла в ретейл
			

/*
select * from Appeals;
drop table Appeals;
*/






-- =========================ACTIONS=========================================
create table Actions
(
	action_id INT not null, 
	subs_id INT not null,
	channel_id INT not null,
	rate_plan_id INT not null,
	lk_actions_id INT not null,
	action_date timestamp not null,	
	constraint pk_actions primary key (action_id),
	constraint fk_actions_channels foreign key(channel_id)
		references Channels(channel_id),
	constraint fk_actions_rate_plans foreign key(rate_plan_id)
		references Rate_Plans(rate_plan_id),
	constraint fk_actions_appeal_lk_actions foreign key(lk_actions_id)
		references lk_actions(lk_actions_id)
);

insert into Actions (action_id,lk_actions_id,subs_id,rate_plan_id,action_date,channel_id)
	values	(1,0,01,2,'2018-06-15 14:40:00',1), --Бабка зашла в ЛК ( не получилось сменить тп)
	
		(2,1,02,4,'2018-05-15 14:40:00',1), --Маша (сменила ТП)
		
		(3,0,02,4,'2018-05-18 12:15:00',1), --Маша 

		(4,3,03,6,'2018-05-25 10:10:00',1), -- Саша зашел в ЛК отключить услугу

		(5,5,04,1,'2018-05-20 18:15:00',1), -- Лёша узнал как поменять пароль, пошёл в ЛК и сменил

		(6,5,04,1,'2018-05-23 11:44:00',1), -- Лёша заказал детализацию счета
		
		(7,0,05,7,'2018-05-25 14:15:00',1), -- Аркаша зашел в Лк но не разобрался(пошел в ретайл)

		(8,1,05,4,'2018-06-21 11:55:00',1), -- Аркаша сам сменил себе ТП в ЛК

		(9,4,06,1,'2018-05-16 17:25:00',1),  -- АНгелина зашла в ЛК и заказала детализацию

		(10,0,07,6,'2018-05-17 13:10:00',1), --Коля зашел в ЛК посмотреть баланс
		(11,0,07,6,'2018-05-17 13:40:00',1), --Коля зашел в ЛК,денег нет!

		(12,0,08,2,'2018-05-10 11:30:00',1) -- Аня хочет симку, зашла в ЛК посмотреть инфу
			

/*
select * from Actions;
drop table Actions;
*/





select un.* 
  from (select apl.subs_id, aplt.def as theme, rtpl.def, apl.reg_date as Datetime, ch.def
          from Appeals apl
          join Appeal_themes aplt on apl.theme_id = aplt.theme_id
          join Channels ch        on apl.channel_id = ch.channel_id
          join Rate_Plans rtpl    on apl.rate_plan_id = rtpl.rate_plan_id

       union
  
      select act.subs_id, lk_act.name_actions as theme, rtpl.def, act.action_date as Datetime, ch.def
        from Actions act
        join Channels ch        on act.channel_id = ch.channel_id
        join Rate_Plans rtpl    on act.rate_plan_id = rtpl.rate_plan_id
        join lk_actions lk_act  on act.lk_actions_id = lk_act.lk_actions_id) as un
 order by un.subs_id asc,
          un.Datetime asc












         